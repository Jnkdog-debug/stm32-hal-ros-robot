

# 系统框图


┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        上位机 (ROS/PC)                                         │
│                                                                                                │
│  ┌──────────────────┐  ┌──────────────────┐  ┌────────────────────┐                          │
│  │   ROS Navigation │  │  ROS tf (坐标系) │  │  RVIZ (可视化)     │                          │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬───────────┘                          │
│           │                      │                     │                                      │
│  ┌────────────────────────────────────────┐                                                  │
│  │   速度指令生成 (Vx, Vy, ωz)            │                                                  │
│  └────────┬─────────────────────────────┘                                                    │
│           │                                                                                   │
└───────────┼───────────────────────────────────────────────────────────────────────────────────┘
            │ 通过 UART 串口发送
            │ 协议帧: [AA 55 20 ... CRC]
            │ (CMD_ID_SET_PARAM)
            ↓
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                       STM32F407 下位机 (FreeRTOS)                                              │
│                                                                                                │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              UART 通信层 (已完成)                                      │   │
│  │                                                                                        │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐                     │   │
│  │  │  UartRxTask      │  │  UartTxTask      │  │ Protocol Handler │                     │   │
│  │  │ (接收+分发)      │  │ (DMA异步发送)    │  │ (打包/解析)      │                     │   │
│  │  └────────┬─────────┘  └────────┬─────────┘  └──────────────────┘                     │   │
│  │           │                     │                                                      │   │
│  │           ↓                     ↑                                                      │   │
│  │  ┌────────────────────────────────────────┐                                           │   │
│  │  │  UartTxQueueHandle (消息队列)          │  ← 所有任务投入发送队列                    │   │
│  │  │  (所有发送数据的集中点)                │                                           │   │
│  │  └────────────────────────────────────────┘                                           │   │
│  │                                                                                        │   │
│  └────────────────────────────────────────────────────────────────────────────────────────┘   │
│                          ↑                                        ↑                           │
│                          │ 投入队列                               │ 取出队列                  │
│         ┌────────────────┴────────────────┐                       │                           │
│         │                                 │                       │                           │
│  ┌──────┴──────────────────────────────────────────────────────────────┐                      │
│  │                                                                       │                     │
│  │  ░░░░░░░░░░░░ FreeRTOS 多任务系统 ░░░░░░░░░░░░                      │                     │
│  │                                                                       │                     │
│  │  ┌─────────────────────────────────────────────────────────────┐    │                     │
│  │  │ 运动控制子系统 (3个任务)                                     │    │                     │
│  │  │                                                              │    │                     │
│  │  │  【MotorControlTask】                                        │    │                     │
│  │  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │    │                     │
│  │  │  1️⃣ 接收上位机速度指令 (Vx, Vy, ωz)                        │    │                     │
│  │  │     ↓ xTaskNotify 唤醒                                      │    │                     │
│  │  │  2️⃣ 运动学逆解算 (Inverse Kinematics)                      │    │                     │
│  │  │     Vx, Vy, ωz → [ω₁, ω₂, ω₃, ω₄]                         │    │                     │
│  │  │  3️⃣ 四路PID控制                                            │    │                     │
│  │  │     对每个轮子执行: PWM = PID(ω_target, ω_actual)           │    │                     │
│  │  │  4️⃣ 编码器反馈 + 运动学正解算                              │    │                     │
│  │  │     [ω₁', ω₂', ω₃', ω₄'] → Vx', Vy', ωz'                 │    │                     │
│  │  │  5️⃣ 里程计积分 (Odometry Integration)                      │    │                     │
│  │  │     x = x + Vx' * dt                                        │    │                     │
│  │  │     y = y + Vy' * dt                                        │    │                     │
│  │  │     θ = θ + ωz' * dt                                        │    │                     │
│  │  │  6️⃣ 周期发送里程计数据到队列                               │    │                     │
│  │  │     投入 UartTxQueueHandle                                  │    │                     │
│  │  └─────────────────────────────────────────────────────────────┘    │                     │
│  │                                                                      │                     │
│  │  ┌─────────────────────────────────────────────────────────────┐    │                     │
│  │  │ 姿态感知子系统 (2个任务)                                     │    │                     │
│  │  │                                                              │    │                     │
│  │  │  【IMUSensorTask】                                           │    │                     │
│  │  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │    │                     │
│  │  │  1️⃣ 读取 MPU6050 (Accel + Gyro)                            │    │                     │
│  │  │     accel = [ax, ay, az]                                    │    │                     │
│  │  │     gyro = [gx, gy, gz]                                     │    │                     │
│  │  │  2️⃣ DMP 算法或四元数融合滤波                               │    │                     │
│  │  │     融合 Accel + Gyro → 四元数 Q(w, x, y, z)               │    │                     │
│  │  │  3️⃣ 四元数转欧拉角 (姿态)                                  │    │                     │
│  │  │     Q → (Roll, Pitch, Yaw)                                  │    │                     │
│  │  │  4️⃣ 周期发送IMU数据到队列                                  │    │                     │
│  │  │     投入 UartTxQueueHandle                                  │    │                     │
│  │  └─────────────────────────────────────────────────────────────┘    │                     │
│  │                                                                      │                     │
│  │  ┌─────────────────────────────────────────────────────────────┐    │                     │
│  │  │ 通信处理子系统 (2个任务 - 已有)                                 │    │                     │
│  │  │                                                             │    │                     │
│  │  │  【UartRxTask】                                              │    │                     │
│  │  │  接收 → 解析 → 分发命令给 MotorControlTask                      │    │                     │
│  │  │                                                              │    │                     │
│  │  │  【UartTxTask】                                               │    │                     │
│  │  │  从队列取帧 → DMA发送                                         │    │                     │
│  │  └─────────────────────────────────────────────────────────────┘    │                     │
│  │                                                                      │                     │
│  └──────────────────────────────────────────────────────────────────────┘                     │
│                                                                                                │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                          硬件驱动层 (HAL)                                              │   │
│  │                                                                                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ UART3 + DMA  │  │ Timer        │  │ GPIO         │  │ I2C (MPU6050)│               │   │
│  │  │ (通信)       │  │ (编码器PWM)  │  │ (电机控制)   │  │ (IMU)        │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                                        │   │
│  └────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    电机和传感器硬件                                                    │   │
│  │                                                                                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ 电机1 (M1)   │  │ 电机2 (M2)   │  │ 电机3 (M3)   │  │ 电机4 (M4)   │               │   │
│  │  │ + 编码器      │  │ + 编码器      │  │ + 编码器      │  │ + 编码器      │               │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘               │   │
│  │                                                                                        │   │
│  │  ┌──────────────────────────────────────┐  ┌──────────────────────────────┐           │   │
│  │  │      MPU6050 (6轴IMU)                │  │   麦克纳姆轮底盘 (4轮)       │           │   │
│  │  │  Accel (3轴) + Gyro (3轴)            │  │   Vx, Vy, ωz (全向移动)     │           │   │
│  │  └──────────────────────────────────────┘  └──────────────────────────────┘           │   │
│  │                                                                                        │   │
│  └────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘