好的，我将以**严肃、正式的语气**，为您整理您的项目需求、我们确定的开发计划以及关键的硬件配置，并将其格式化为一份专业、结构化的 `README.md` 文件。

这份文档将作为项目开发的指导和记录。

***

# 🤖 ROS 麦克纳姆轮机器人底盘嵌入式项目开发文档

## 1. 项目概述

本项目旨在开发一个基于 **STM32F407VET6** 微控制器的麦克纳姆轮机器人底盘嵌入式控制系统。该系统需实现精确的运动控制、姿态感知、里程计计算，并与 ROS 上位机通过串口进行高效、可靠的数据交互。

### 1.1 核心技术栈

* **主控芯片：** STM32F407VET6
* **实时操作系统：** FreeRTOS
* **底层驱动：** STM32 HAL 库
* **通信协议：** 串行通信 (UART) + 自定义数据帧协议
* **运动控制：** 四轮麦克纳姆轮，PID 闭环速度控制
* **传感器：** MPU6050 (姿态融合)
* **开发环境：** STM32CubeMX

### 1.2 待完成任务 (需求清单)

1.  **电机控制：** 对四个霍尔编码电机实施 PID 闭环速度控制。
2.  **里程计计算：** 结合电机编码器数据和 MPU6050 姿态数据，实现底盘里程计 (Odometry) 计算。
3.  **串行通信：** 实现基于数据帧（数据栈）的串口通信协议，用于接收上位机指令和发送底盘状态/里程计数据。
4.  **系统调度：** 在 FreeRTOS 框架下，合理规划并调度各功能任务。

***

## 2. 硬件资源分配概览 (STM32F407VET6 集成板)

本项目的开发基于提供的 STM32F407VET6 集成板，关键资源分配如下表所示。

| 功能模块 | 外设 / 接口 | 引脚分配 | 状态 | 引用源 |
| :--- | :--- | :--- | :--- | :--- |
| **主通信 (ROS)** | USART1 (Type-C) | PA9 (TX), PA10 (RX) | [cite_start]已分配 | [cite: 1] |
| **电机 A PWM** | TIM10\_CH1, TIM11\_CH1 | PB8, PB9 | [cite_start]已分配 | [cite: 1] |
| **电机 A 编码器** | TIM2\_CH1, CH2 | PA15, PB3 | [cite_start]已分配 | [cite: 1] |
| **电机 B PWM** | TIM9\_CH1, CH2 | PE5, PE6 | [cite_start]已分配 | [cite: 1] |
| **电机 B 编码器** | TIM3\_CH1, CH2 | PB4, PB5 | [cite_start]已分配 | [cite: 3] |
| **电机 C PWM** | TIM1\_CH1, CH2 | PE9, PE11 | [cite_start]已分配 | [cite: 1] |
| **电机 C 编码器** | TIM4\_CH1, CH2 | PB6, PB7 | [cite_start]已分配 | [cite: 3] |
| **MPU6050 接口** | I/O | PB10, PB11, PB12 | [cite_start]已分配 | [cite: 1] |
| **系统 LED** | I/O | PA12 | [cite_start]已分配 | [cite: 1] |
| **系统电压 ADC** | ADC | PB0, PB1 | [cite_start]已分配 | [cite: 1, 3] |

***

## 3. 分阶段开发计划

本项目将划分为三个主要阶段，以确保系统按模块、稳健地推进。

### 阶段一：系统基础与通信协议建立 (已确定)

**目标：** 实现 FreeRTOS 任务调度骨架，并建立高效、可靠的上位机通信链路。

| 任务编号 | 任务名称 | 实现细节与技术选型 |
| :---: | :--- | :--- |
| **T1** | FreeRTOS 任务规划 | 定义 `RecvTask`, `ControlTask`, `SendTask` 等核心任务，确定优先级和堆栈。 |
| **T2** | 串行通信协议实现 | [cite_start]采用 **USART1** (PA9, PA10) [cite: 1]。利用 **DMA 循环模式** 和 **IDLE 空闲线中断** 机制，实现可靠的数据帧接收和解包。 |
| **T3** | 数据传输机制确定 | 任务间数据传输使用 **FreeRTOS 消息队列 (Message Queue)**。例如，`RecvTask` 将解析后的目标速度指令入队，供 `ControlTask` 消费。使用 **事件组/信号量** 进行中断与任务间的同步。 |

### 阶段二：传感器与运动控制核心

**目标：** 实现 PID 闭环控制和姿态数据的稳定获取。

| 任务编号 | 任务名称 | 关键技术 |
| :---: | :--- | :--- |
| **T4** | MPU6050 数据融合 | [cite_start]基于 PB10, PB11, PB12 [cite: 1] 实现驱动，使用卡尔曼滤波/互补滤波获取稳定偏航角 $(\psi)$。 |
| **T5** | 电机 PID 调参 | 在 `ControlTask` 中，基于编码器反馈，调试四个电机的速度 PID 参数，实现稳定的速度闭环控制。 |

### 阶段三：底盘运动学与里程计计算

**目标：** 实现机器人运动学转换，并完成 ROS 要求的里程计数据输出。

| 任务编号 | 任务名称 | 关键技术 |
| :---: | :--- | :--- |
| **T6** | 麦克纳姆轮运动学模型 | 实现逆运动学 (目标速度转轮速) 和正运动学 (轮速转底盘速度)。 |
| **T7** | 里程计计算与发布 | 结合 **T4** 的偏航角和 **T6** 的正运动学结果，计算底盘的全局位置 $(x, y, \theta)$，并通过 `SendTask` 周期性地发布给上位机。 |

***

## 4. 关键技术点与下一步计划

### 4.1 通信可靠性保障

* **数据帧结构：** 采用 `[帧头] + [长度] + [命令字] + [数据] + [校验和] + [帧尾]` 的结构。
* **接收机制：** 利用 DMA 循环接收数据流，并结合 USART IDLE 中断判断数据帧结束，确保不丢帧且准确解析。

### 4.2 下一步行动

下一阶段工作将聚焦于 **CubeMX 的配置和阶段一 (T1, T2, T3) 的代码实现**，特别是 USART1 的 DMA/IDLE 中断逻辑和 FreeRTOS 任务的同步机制。
